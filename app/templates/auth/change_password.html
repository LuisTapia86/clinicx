{% extends "base/base.html" %}

{% block title %}Change Password - ClinicX{% endblock %}

{% block content %}
<!--
    Change Password Page

    Purpose: Allow users to change their password securely
    Features:
    - Current password verification
    - New password confirmation
    - Client-side and server-side validation
    - Security requirements display

    Security considerations:
    - Minimum password length: 6 characters (configurable)
    - Current password must be verified
    - New password must be confirmed
    - Passwords are hashed using Werkzeug (PBKDF2 + SHA-256)

    Future enhancements:
    - Password strength meter
    - Password history (prevent reuse)
    - Password complexity requirements
    - Send email notification on password change
-->

<div class="container">
    <div class="row">
        <div class="col-md-6 mx-auto">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="h2">
                    <i class="bi bi-key"></i> Change Password
                </h1>
                <p class="text-muted">Update your password to keep your account secure</p>
            </div>

            <!-- Change Password Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock"></i> Security Update
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('auth.change_password') }}" id="changePasswordForm">
                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock-fill"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="current_password"
                                       name="current_password"
                                       placeholder="Enter your current password"
                                       required>
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('current_password')">
                                    <i class="bi bi-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Enter your current password to verify your identity
                            </small>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key-fill"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="new_password"
                                       name="new_password"
                                       placeholder="Enter new password"
                                       minlength="6"
                                       required>
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('new_password')">
                                    <i class="bi bi-eye" id="new_password_icon"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Password must be at least 6 characters long
                            </small>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-check2-square"></i>
                                </span>
                                <input type="password"
                                       class="form-control"
                                       id="confirm_password"
                                       name="confirm_password"
                                       placeholder="Re-enter new password"
                                       minlength="6"
                                       required>
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        onclick="togglePassword('confirm_password')">
                                    <i class="bi bi-eye" id="confirm_password_icon"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Re-enter your new password to confirm
                            </small>
                        </div>

                        <!-- Password Requirements Info -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-info-circle"></i> Password Requirements
                            </h6>
                            <ul class="mb-0 small">
                                <li>Minimum 6 characters</li>
                                <li>Use a unique password you don't use elsewhere</li>
                                <li>Consider using a mix of letters, numbers, and symbols</li>
                                <li>Avoid common words or personal information</li>
                            </ul>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-shield-check"></i> Update Password
                            </button>
                            <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Security Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li>Change your password regularly (every 3-6 months)</li>
                        <li>Never share your password with anyone</li>
                        <li>Use different passwords for different accounts</li>
                        <li>Consider using a password manager</li>
                        <li>Enable two-factor authentication when available</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Toggle password visibility
 * @param {string} fieldId - ID of the password input field
 */
function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');

    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        passwordField.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

/**
 * Form validation before submission
 */
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    // Check if passwords match
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('New passwords do not match. Please try again.');
        return false;
    }

    // Check minimum length
    if (newPassword.length < 6) {
        e.preventDefault();
        alert('Password must be at least 6 characters long.');
        return false;
    }

    return true;
});

/**
 * Real-time password match indicator
 */
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    const confirmField = this;

    if (confirmPassword.length > 0) {
        if (newPassword === confirmPassword) {
            confirmField.classList.remove('is-invalid');
            confirmField.classList.add('is-valid');
        } else {
            confirmField.classList.remove('is-valid');
            confirmField.classList.add('is-invalid');
        }
    } else {
        confirmField.classList.remove('is-valid', 'is-invalid');
    }
});
</script>
{% endblock %}
