{% extends "base/base.html" %}

{% block title %}Patients - ClinicX{% endblock %}

{% block content %}
<!--
    Patients List Page

    Purpose: Display all active patients with search and pagination
    Features:
    - Searchable patient list (by name, email, phone)
    - Pagination for large datasets
    - Quick actions (view, edit)
    - Patient count statistics
    - Create new patient button

    Developer notes:
    - Search is case-insensitive
    - Only active patients are shown by default
    - Pagination: 10 patients per page (configurable in config.py)
    - Uses SQLAlchemy pagination object

    Future enhancements:
    - Advanced filters (age range, gender, blood type)
    - Export to CSV/Excel
    - Bulk actions
    - Sort by columns
    - Show inactive patients toggle
-->

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="h2">
                <i class="bi bi-people"></i> Patients
            </h1>
            <p class="text-muted">Manage patient records and information</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('patients.create') }}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> New Patient
            </a>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-8">
            <form method="GET" action="{{ url_for('patients.index') }}" class="d-flex">
                <input type="text"
                       class="form-control me-2"
                       name="search"
                       placeholder="Search by name, email, or phone..."
                       value="{{ search }}"
                       id="searchInput">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-search"></i> Search
                </button>
                {% if search %}
                <a href="{{ url_for('patients.index') }}" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-x-circle"></i> Clear
                </a>
                {% endif %}
            </form>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge bg-info fs-6">
                Total Patients: {{ patients.total }}
            </span>
        </div>
    </div>

    <!-- Patients Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            {% if patients.items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Blood Type</th>
                                <th>Registered</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in patients.items %}
                            <tr>
                                <td class="text-muted">#{{ patient.id }}</td>
                                <td>
                                    <a href="{{ url_for('patients.view', patient_id=patient.id) }}"
                                       class="text-decoration-none fw-bold">
                                        {{ patient.full_name }}
                                    </a>
                                </td>
                                <td>
                                    {% if patient.age %}
                                        {{ patient.age }} years
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if patient.gender %}
                                        <span class="badge bg-{{ 'primary' if patient.gender == 'male' else 'danger' if patient.gender == 'female' else 'secondary' }}">
                                            {{ patient.gender.capitalize() }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="bi bi-telephone"></i>
                                    {{ patient.phone }}
                                </td>
                                <td>
                                    {% if patient.email %}
                                        <i class="bi bi-envelope"></i>
                                        {{ patient.email }}
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if patient.blood_type %}
                                        <span class="badge bg-danger">
                                            {{ patient.blood_type }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">
                                    {{ patient.created_at.strftime('%m/%d/%Y') }}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('patients.view', patient_id=patient.id) }}"
                                           class="btn btn-outline-primary"
                                           title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('patients.edit', patient_id=patient.id) }}"
                                           class="btn btn-outline-warning"
                                           title="Edit Patient">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{{ url_for('appointments.create', patient_id=patient.id) }}"
                                           class="btn btn-outline-success"
                                           title="Schedule Appointment">
                                            <i class="bi bi-calendar-plus"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if patients.pages > 1 %}
                <div class="card-footer bg-white">
                    <nav aria-label="Patients pagination">
                        <ul class="pagination justify-content-center mb-0">
                            <!-- Previous Page -->
                            <li class="page-item {{ 'disabled' if not patients.has_prev }}">
                                <a class="page-link"
                                   href="{{ url_for('patients.index', page=patients.prev_num, search=search) if patients.has_prev else '#' }}">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            {% for page_num in range(1, patients.pages + 1) %}
                                {% if page_num == patients.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% elif page_num <= 3 or page_num > patients.pages - 3 or (page_num >= patients.page - 1 and page_num <= patients.page + 1) %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="{{ url_for('patients.index', page=page_num, search=search) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% elif page_num == patients.page - 2 or page_num == patients.page + 2 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Next Page -->
                            <li class="page-item {{ 'disabled' if not patients.has_next }}">
                                <a class="page-link"
                                   href="{{ url_for('patients.index', page=patients.next_num, search=search) if patients.has_next else '#' }}">
                                    Next <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Pagination Info -->
                    <div class="text-center text-muted small mt-2">
                        Showing {{ patients.first }} to {{ patients.last }} of {{ patients.total }} patients
                    </div>
                </div>
                {% endif %}

            {% else %}
                <!-- No Patients Found -->
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3">No Patients Found</h4>
                    {% if search %}
                        <p class="text-muted">
                            No patients match your search for "{{ search }}".
                            <a href="{{ url_for('patients.index') }}">Clear search</a> to see all patients.
                        </p>
                    {% else %}
                        <p class="text-muted">
                            Get started by adding your first patient.
                        </p>
                        <a href="{{ url_for('patients.create') }}" class="btn btn-primary mt-3">
                            <i class="bi bi-person-plus"></i> Add First Patient
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-focus search input on page load
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput && !searchInput.value) {
        // Only focus if there's no search value (prevents auto-scroll on search results)
        // searchInput.focus();
    }
});

// Keyboard shortcut: Ctrl+F or Cmd+F to focus search
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
});
</script>
{% endblock %}
