{% extends "base/base.html" %}

{% block title %}{{ patient.full_name }} - Patient Details{% endblock %}

{% block content %}
<!--
    Patient Details Page

    Purpose: Comprehensive view of patient information and history
    Features:
    - Complete patient demographics
    - Medical history summary
    - Recent appointments
    - Recent transactions
    - Quick actions (edit, add medical record, schedule appointment)
    - Emergency contact information
    - Insurance details

    Developer notes:
    - All relationships are lazy-loaded for performance
    - Recent items are limited to 5 for initial view
    - Full history accessible through dedicated pages
    - Delete action restricted to admins only

    Future enhancements:
    - Patient photo upload
    - Print patient summary
    - Email patient information
    - Generate patient ID card
    - Patient portal access
    - Document management system
-->

<div class="container-fluid">
    <!-- Header with Actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('patients.index') }}">Patients</a>
                    </li>
                    <li class="breadcrumb-item active">{{ patient.full_name }}</li>
                </ol>
            </nav>
            <h1 class="h2">
                <i class="bi bi-person-circle"></i> {{ patient.full_name }}
                {% if not patient.is_active %}
                    <span class="badge bg-danger">Inactive</span>
                {% endif %}
            </h1>
            <p class="text-muted">Patient ID: #{{ patient.id }} | Registered: {{ patient.created_at.strftime('%B %d, %Y') }}</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{{ url_for('patients.edit', patient_id=patient.id) }}"
                   class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{{ url_for('medical.create', patient_id=patient.id) }}"
                   class="btn btn-success">
                    <i class="bi bi-file-medical"></i> Add Record
                </a>
                <a href="{{ url_for('appointments.create', patient_id=patient.id) }}"
                   class="btn btn-primary">
                    <i class="bi bi-calendar-plus"></i> Schedule
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Patient Information -->
        <div class="col-md-8">
            <!-- Personal Information Card -->
            <div class="card shadow-sm mb-4 patient-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge"></i> Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Full Name</label>
                            <p class="h5">{{ patient.full_name }}</p>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label text-muted small">Age</label>
                            <p class="h5">
                                {% if patient.age %}
                                    {{ patient.age }} years
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label text-muted small">Date of Birth</label>
                            <p class="h5">{{ patient.date_of_birth.strftime('%m/%d/%Y') }}</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted small">Gender</label>
                            <p class="h5">
                                {% if patient.gender %}
                                    <span class="badge bg-{{ 'primary' if patient.gender == 'male' else 'danger' if patient.gender == 'female' else 'secondary' }}">
                                        {{ patient.gender.capitalize() }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted small">Blood Type</label>
                            <p class="h5">
                                {% if patient.blood_type %}
                                    <span class="badge bg-danger">{{ patient.blood_type }}</span>
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-muted small">Phone</label>
                            <p class="h5">
                                <i class="bi bi-telephone"></i> {{ patient.phone }}
                            </p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Email</label>
                            <p class="h5">
                                {% if patient.email %}
                                    <i class="bi bi-envelope"></i>
                                    <a href="mailto:{{ patient.email }}">{{ patient.email }}</a>
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Address</label>
                            <p class="mb-0">
                                {% if patient.address %}
                                    {{ patient.address }}<br>
                                    {% if patient.city or patient.state or patient.zip_code %}
                                        {{ patient.city }}{% if patient.city and patient.state %}, {% endif %}{{ patient.state }} {{ patient.zip_code }}
                                    {% endif %}
                                    {% if patient.country %}<br>{{ patient.country }}{% endif %}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-heart-pulse"></i> Medical Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Allergies</label>
                            <p class="mb-0">
                                {% if patient.allergies %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle"></i> Has Allergies
                                    </span>
                                    <br><small>{{ patient.allergies }}</small>
                                {% else %}
                                    <span class="text-muted">No known allergies</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Chronic Conditions</label>
                            <p class="mb-0">
                                {% if patient.chronic_conditions %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-info-circle"></i> Has Conditions
                                    </span>
                                    <br><small>{{ patient.chronic_conditions }}</small>
                                {% else %}
                                    <span class="text-muted">No chronic conditions</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Insurance Provider</label>
                            <p class="mb-0">
                                {% if patient.insurance_provider %}
                                    {{ patient.insurance_provider }}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Insurance Number</label>
                            <p class="mb-0">
                                {% if patient.insurance_number %}
                                    {{ patient.insurance_number }}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-exclamation"></i> Emergency Contact
                    </h5>
                </div>
                <div class="card-body">
                    {% if patient.emergency_contact_name %}
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label text-muted small">Name</label>
                                <p class="h6">{{ patient.emergency_contact_name }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">Phone</label>
                                <p class="h6">
                                    <i class="bi bi-telephone"></i>
                                    {{ patient.emergency_contact_phone or 'Not provided' }}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">Relationship</label>
                                <p class="h6">{{ patient.emergency_contact_relationship or 'Not specified' }}</p>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No emergency contact information provided</p>
                    {% endif %}
                </div>
            </div>

            <!-- Referral Information Card -->
            {% if patient.referred_by or patient.referral_source or patient.referral_notes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-check"></i> Referral Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if patient.referred_by %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Referred By</label>
                            <p class="h6">{{ patient.referred_by }}</p>
                        </div>
                        {% endif %}

                        {% if patient.referral_source %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">How They Heard About Us</label>
                            <p>
                                <span class="badge bg-info">
                                    {% if patient.referral_source == 'social_media' %}
                                        Social Media
                                    {% elif patient.referral_source == 'friend_family' %}
                                        Friend/Family
                                    {% elif patient.referral_source == 'doctor_referral' %}
                                        Doctor Referral
                                    {% elif patient.referral_source == 'online_search' %}
                                        Online Search
                                    {% elif patient.referral_source == 'advertisement' %}
                                        Advertisement
                                    {% elif patient.referral_source == 'walk_in' %}
                                        Walk-in
                                    {% else %}
                                        {{ patient.referral_source|title }}
                                    {% endif %}
                                </span>
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    {% if patient.referral_notes %}
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label text-muted small">Referral Notes</label>
                            <p class="mb-0">{{ patient.referral_notes }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Notes Card (if any) -->
            {% if patient.notes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-sticky"></i> Notes
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ patient.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Activity and Quick Stats -->
        <div class="col-md-4">
            <!-- Quick Stats -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Quick Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-muted">Total Visits</small>
                            <h4 class="mb-0">{{ patient.medical_records.count() }}</h4>
                        </div>
                        <i class="bi bi-file-medical display-4 text-muted opacity-25"></i>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-muted">Appointments</small>
                            <h4 class="mb-0">{{ patient.appointments.count() }}</h4>
                        </div>
                        <i class="bi bi-calendar-check display-4 text-muted opacity-25"></i>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Outstanding Balance</small>
                            <h4 class="mb-0 text-{{ 'danger' if patient.get_total_debt() > 0 else 'success' }}">
                                ${{ "%.2f"|format(patient.get_total_debt()) }}
                            </h4>
                        </div>
                        <i class="bi bi-cash-stack display-4 text-muted opacity-25"></i>
                    </div>
                </div>
            </div>

            <!-- Recent Medical Records -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-file-medical"></i> Recent Visits
                    </h6>
                    <a href="{{ url_for('medical.patient_records', patient_id=patient.id) }}"
                       class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body p-0">
                    {% set recent_records = patient.medical_records.limit(5).all() %}
                    {% if recent_records %}
                        <ul class="list-group list-group-flush">
                            {% for record in recent_records %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ record.visit_reason[:40] }}...</h6>
                                        <small class="text-muted">
                                            {{ record.visit_date.strftime('%B %d, %Y') }}
                                        </small>
                                    </div>
                                    <a href="{{ url_for('medical.view', record_id=record.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center py-3 mb-0">No medical records yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Upcoming Appointments -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-calendar-event"></i> Upcoming Appointments
                    </h6>
                    <a href="{{ url_for('appointments.create', patient_id=patient.id) }}"
                       class="btn btn-sm btn-outline-success">
                        <i class="bi bi-plus"></i> Schedule
                    </a>
                </div>
                <div class="card-body p-0">
                    {% set upcoming = patient.get_upcoming_appointments() %}
                    {% if upcoming %}
                        <ul class="list-group list-group-flush">
                            {% for appointment in upcoming[:5] %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ appointment.reason[:40] }}...</h6>
                                        <small class="text-muted">
                                            {{ appointment.appointment_date.strftime('%B %d, %Y at %I:%M %p') }}
                                        </small>
                                        <br>
                                        <span class="badge bg-{{ 'primary' if appointment.status == 'scheduled' else 'success' }}">
                                            {{ appointment.status }}
                                        </span>
                                    </div>
                                    <a href="{{ url_for('appointments.view', appointment_id=appointment.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center py-3 mb-0">No upcoming appointments</p>
                    {% endif %}
                </div>
            </div>

            <!-- Patient Referrals Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-person-plus"></i> Patient Referrals
                    </h6>
                    <small class="d-block mt-1">People this patient wants to refer</small>
                </div>
                <div class="card-body">
                    <!-- Add New Referral Form -->
                    <form method="POST" action="{{ url_for('patients.add_referral', patient_id=patient.id) }}" class="mb-3">
                        <div class="mb-2">
                            <label for="referred_name" class="form-label form-label-sm mb-1">Name*</label>
                            <input type="text" class="form-control form-control-sm" id="referred_name"
                                   name="referred_name" required placeholder="Full name">
                        </div>
                        <div class="mb-2">
                            <label for="referred_phone" class="form-label form-label-sm mb-1">Phone*</label>
                            <input type="tel" class="form-control form-control-sm" id="referred_phone"
                                   name="referred_phone" required placeholder="555-1234">
                        </div>
                        <div class="mb-2">
                            <label for="referred_email" class="form-label form-label-sm mb-1">Email</label>
                            <input type="email" class="form-control form-control-sm" id="referred_email"
                                   name="referred_email" placeholder="email@example.com">
                        </div>
                        <div class="mb-2">
                            <label for="relationship" class="form-label form-label-sm mb-1">Relationship</label>
                            <select class="form-select form-select-sm" id="relationship" name="relationship">
                                <option value="">Select relationship</option>
                                <option value="family">Family Member</option>
                                <option value="friend">Friend</option>
                                <option value="coworker">Coworker</option>
                                <option value="neighbor">Neighbor</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="notes" class="form-label form-label-sm mb-1">Notes</label>
                            <textarea class="form-control form-control-sm" id="notes" name="notes"
                                      rows="2" placeholder="Additional information..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Add Referral
                        </button>
                    </form>

                    <hr>

                    <!-- List of Existing Referrals -->
                    <h6 class="mb-2">Referral List</h6>
                    {% set referrals = patient.referrals.all() %}
                    {% if referrals %}
                        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            {% for referral in referrals %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">{{ referral.referred_name }}</h6>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-telephone"></i> {{ referral.referred_phone }}
                                        </small>
                                        {% if referral.referred_email %}
                                        <small class="text-muted d-block">
                                            <i class="bi bi-envelope"></i> {{ referral.referred_email }}
                                        </small>
                                        {% endif %}
                                        {% if referral.relationship %}
                                        <small class="text-muted d-block">
                                            <i class="bi bi-people"></i> {{ referral.relationship_display }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <span class="badge {{ referral.status_badge_class }}">
                                        {{ referral.status }}
                                    </span>
                                </div>

                                {% if referral.notes %}
                                <p class="mb-2 small text-muted">{{ referral.notes }}</p>
                                {% endif %}

                                <small class="text-muted d-block mb-2">
                                    Added: {{ referral.created_at.strftime('%b %d, %Y') }}
                                    {% if referral.contacted_at %}
                                    | Contacted: {{ referral.contacted_at.strftime('%b %d, %Y') }}
                                    {% endif %}
                                </small>

                                <!-- Update Status Form -->
                                <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                                    <form method="POST" action="{{ url_for('patients.update_referral_status', patient_id=patient.id, referral_id=referral.id) }}" class="d-inline">
                                        <input type="hidden" name="status" value="contacted">
                                        <button type="submit" class="btn btn-outline-info btn-sm"
                                                {% if referral.status == 'contacted' %}disabled{% endif %}>
                                            Contacted
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('patients.update_referral_status', patient_id=patient.id, referral_id=referral.id) }}" class="d-inline">
                                        <input type="hidden" name="status" value="scheduled">
                                        <button type="submit" class="btn btn-outline-primary btn-sm"
                                                {% if referral.status == 'scheduled' %}disabled{% endif %}>
                                            Scheduled
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('patients.update_referral_status', patient_id=patient.id, referral_id=referral.id) }}" class="d-inline">
                                        <input type="hidden" name="status" value="converted">
                                        <button type="submit" class="btn btn-outline-success btn-sm"
                                                {% if referral.status == 'converted' %}disabled{% endif %}>
                                            Converted
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('patients.update_referral_status', patient_id=patient.id, referral_id=referral.id) }}" class="d-inline">
                                        <input type="hidden" name="status" value="declined">
                                        <button type="submit" class="btn btn-outline-secondary btn-sm"
                                                {% if referral.status == 'declined' %}disabled{% endif %}>
                                            Declined
                                        </button>
                                    </form>
                                </div>

                                <!-- Delete Referral Button -->
                                <form method="POST" action="{{ url_for('patients.delete_referral', patient_id=patient.id, referral_id=referral.id) }}"
                                      onsubmit="return confirm('Are you sure you want to delete this referral?');" class="d-inline w-100">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="bi bi-trash"></i> Delete Referral
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0 small">No referrals yet. Use the form above to add one.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Admin Actions (Only for admins) -->
            {% if current_user.is_admin() %}
            <div class="card shadow-sm border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-exclamation"></i> Admin Actions
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('patients.delete', patient_id=patient.id) }}"
                          onsubmit="return confirm('Are you sure you want to deactivate this patient? This will hide them from the main list but preserve their medical history.');">
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-person-x"></i> Deactivate Patient
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2">
                        This will mark the patient as inactive but preserve all medical records.
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
